---
title: "Using D3po with Customizations"
output: rmarkdown::html_vignette
description: >
  Start here if this is your first time using d3po. You'll learn the basic   
  philosophy, and (hopefully) you'll realize it integrates well with the pipe, 
  `%>%`, and the Tidyverse.
vignette: >
  %\VignetteIndexEntry{Using D3po with Customizations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  eval = TRUE,
  comment = "#>",
  fig.width = 10,
  fig.height = 5
)
```

The package `d3po` integrates well with `dplyr`. All the examples here use the 
pipe, `%>%`, both to filter/summarise data and create the charts.

These examples are the same as in the documentation but with some extended comments.

# Setup

Let's start by loading packages.

```{r pkgs, message=FALSE, warning=FALSE}
library(d3po)
```

# Pokemon dataset

The included dataset, `pokemon`, has a detailed documentation but let's explore the data structure:

```{r data}
str(pokemon)
```

# Box and whiskers with custom axis labels and axis units

```{r box-custom}
pokemon_custom <- pokemon
pokemon_custom$weight_g <- pokemon_custom$weight * 1000

d3po(pokemon_custom, width = 800, height = 600) %>%
  po_box(daes(x = type_1, y = weight_g, color = color_1)) %>%
  po_format(
    x = toupper(type_1),
    y = format(weight_g, big.mark = " ", scientific = FALSE)
  ) %>%
  po_labels(
    x = "Pokemon Type (uppercase)",
    y = "Weight (grams)",
    title = "Weight Distribution by Type"
  )

d3po(pokemon_custom, width = 800, height = 600) %>%
  po_box(daes(x = weight_g, y = type_1, color = color_1)) %>%
  po_format(
    x = format(weight_g, big.mark = " ", scientific = FALSE),
    y = toupper(type_1)
  ) %>%
  po_labels(
    x = "Weight (grams)",
    y = "Pokemon Type (uppercase)",
    title = "Weight Distribution by Type"
  )
```

# Bar with custom axis labels and axis units

```{r bar-custom}
dout <- aggregate(weight ~ type_1 + color_1, data = pokemon, FUN = mean)
names(dout) <- c("type", "color", "avg_weight")

d3po(dout, width = 800, height = 600) %>%
  po_bar(daes(x = type, y = avg_weight, color = color)) %>%
  po_format(
    x = toupper(type),
    y = round(avg_weight, 2)
  ) %>%
  po_labels(
    x = "Type",
    y = "Mean Weight",
    title = "Vertical Bars"
  )

d3po(dout, width = 800, height = 600) %>%
  po_bar(daes(x = avg_weight, y = type, color = color)) %>%
  po_format(
    x = round(avg_weight, 2),
    y = toupper(type)
  ) %>%
  po_labels(
    x = "Mean Weight",
    y = "Type",
    title = "Horizontal Bars"
  )
```

# Treemap with custom labels and tooltip

```{r treemap-custom}
dout <- aggregate(cbind(count = rep(1, nrow(pokemon))) ~ type_1 + color_1, data = pokemon, FUN = length)
names(dout) <- c("type", "color", "count")

d3po(dout, width = 800, height = 600) %>%
  po_treemap(
    daes(
      size = count, group = type, color = color, tiling = "squarify"
    )
  ) %>%
  po_labels(
    align = "center-middle",
    title = "Share of Pokemon by main type"
  ) %>%
  po_tooltip("<i>Type: {type}</i><br/>Count: {count}")
```

# Treemap with custom labels and tooltip (more changes to the displayed labels)

```{r treemap-custom-2}
dout <- aggregate(cbind(count = rep(1, nrow(pokemon))) ~ type_1 + color_1, data = pokemon, FUN = length)
names(dout) <- c("type", "color", "count")

d3po(dout, width = 800, height = 600) %>%
  po_treemap(
    daes(
      size = count, group = type, color = color, tiling = "squarify"
    )
  ) %>%
  po_labels(
    align = "center-middle",
    title = "Share of Pokemon by main type",
    labels = JS(
      "function(percentage, row) {
        var pct = (percentage).toFixed(1) + '%';
        var name = (row && (row.type || row.name)) ? (row.type || row.name) : '';
        var count = row && (row.count != null ? row.count : (row.value != null ? row.value : ''));
        return '<i>' + name + '</i><br/>Count: ' + (count || '') + '<br/>Share: ' + pct;
      }"
    )
  ) %>%
  po_tooltip("<i>Type: {type}</i><br/>Count: {count}")
```

# Two-level Treemap with custom labels and tooltip

```{r treemap2}
type2tmp <- as.character(pokemon$type_2)
type2tmp[is.na(type2tmp)] <- "only"
dout <- aggregate(cbind(count = rep(1, nrow(pokemon))) ~ type_1 + type2tmp + color_1,
  data = pokemon, FUN = length
)
names(dout) <- c("type1", "type2", "color", "count")

d3po(dout, width = 800, height = 600) %>%
  po_treemap(
    daes(
      size = count, group = type1, subgroup = type2, color = color, tiling = "squarify"
    )
  ) %>%
  po_labels(
    align = "center-middle",
    title = "Two-level Treemap by Type 1 and Type 2 (click to drill in/out)",
    subtitle = JS(
      "function(_v, row) {
        // row.mode is 'aggregated' | 'flat' | 'drilled'
        if (row && row.mode === 'drilled') return 'Displaying Sub-Type';
        return 'Displaying Main Type';\
      }"
    )
  ) %>%
  po_tooltip(JS(
    "function(percentage, row) {
       var pct = (percentage).toFixed(1) + '%';

       // Minimal tooltip: rely on row.count and explicit row.type1 / row.type2
       var count = row && row.count != null ? row.count : '';

       if (!row || !row.type2) {
         var t1 = row && (row.type1 || row.name) ? (row.type1 || row.name) : '';
         return '<i>Type 1: ' + t1 + '</i><br/>Count: ' + count + '<br/>Percentage: ' + pct;
       }

       // When type2 is the placeholder 'only', hide the Type 2 row in the tooltip
       if (row.type2 === 'only') {
         return '<i>Type 1: ' + (row.type1 || '') + '</i><br/>Count: ' + count + '<br/>Percentage: ' + pct;
       }

       return '<i>Type 1: ' + (row.type1 || '') + '<br/>Type 2: ' + (row.type2 || '') + '</i><br/>Count: ' + count + '<br/>Percentage: ' + pct;
     }"
  ))
```

# Pie with custom labels and tooltip

```{r pie-custom}
dout <- aggregate(cbind(count = rep(1, nrow(pokemon))) ~ type_1 + color_1, data = pokemon, FUN = length)
names(dout) <- c("type", "color", "count")

d3po(dout, width = 800, height = 600) %>%
  po_pie(daes(size = count, group = type, color = color)) %>%
  po_tooltip("<b>Type: {type}</b><br/>Count: {count}") %>%
  po_labels(title = "Full Pie")
```

# Line with custom axis labels

```{r line-custom}
dout <- pokemon[pokemon$name %in% c(
  "Squirtle", "Wartortle", "Blastoise",
  "Charmander", "Charmeleon", "Charizard",
  "Pikachu", "Raichu"
), c("name", "height", "weight", "type_1", "color_1")]

colnames(dout) <- c("pokemon", "height", "weight", "type", "color")

d3po(dout, width = 800, height = 600) %>%
  po_line(
    daes(
      x = height, y = weight, group = type, name = pokemon, color = color
    )
  ) %>%
  po_labels(
    x = "Height (m)",
    y = "Weight (kg)",
    title = "Pokemon Evolution: Weight vs Height by Type"
  ) %>%
  po_tooltip("<b>{pokemon} ({type})</b><br/>(height, weight) = ({height}, {weight})")
```

# Area with custom axis labels and custom tooltip

```{r area-custom}
dout <- pokemon[pokemon$name %in% c(
  "Squirtle", "Wartortle", "Blastoise",
  "Charmander", "Charmeleon", "Charizard",
  "Pikachu", "Raichu"
), c("name", "height", "weight", "type_1", "color_1")]

colnames(dout) <- c("pokemon", "height", "weight", "type", "color")

d3po(dout, width = 800, height = 600) %>%
  po_area(
    daes(
      x = height, y = weight, group = type, name = pokemon, color = color
    )
  ) %>%
  po_labels(
    x = "Height (m)",
    y = "Weight (kg)",
    title = "Pokemon Evolution: Weight vs Height by Type"
  ) %>%
  po_tooltip("<b>{pokemon} ({type})</b><br/>(height, weight) = ({height}, {weight})")
```

# Scatterplot with custom tooltip

```{r scatter-custom}
d3po(pokemon, width = 800, height = 600) %>%
  po_scatter(
    daes(
      x = height, y = weight, group = name, color = color_1
    )
  ) %>%
  po_labels(title = "Height vs Weight") %>%
  po_tooltip("<b>{name}</b><br/>(height, weight) = ({height}, {weight})")
```

# Geomap with custom tooltip

```{r geomap-custom}
# Get country IDs and names from the South America map
dout <- map_ids(d3po::maps$south_america$continent)

# Chile has Mewtwo and Guyana has Mew
dout$pokemon_count <- ifelse(dout$id == "CL", 1L, 0L)
dout$pokemon_count <- ifelse(dout$id == "GY", 1L, dout$pokemon_count)
dout$color <- ifelse(dout$id %in% c("CL", "GY"), "#F85888", "#e0e0e0")

d3po(dout, width = 800, height = 600) %>%
  po_geomap(
    daes(group = id, color = color, size = pokemon_count, tooltip = name),
    map = d3po::maps$south_america$continent
  ) %>%
  po_labels(title = "Pokemon Distribution in South America") %>%
  po_tooltip("<b>Country: {name}</b><br/>Pokemon Count: {pokemon_count}")
```

# Network with custom tooltip

```{r network-custom}
# Using KK layout algorithm
d3po(pokemon_network, width = 800, height = 600) %>%
  po_network(daes(size = node_size, color = color, layout = "kk")) %>%
  po_labels(title = "Pokemon Type Network (Fixed Positions)") %>%
  po_tooltip("{name} node size: {node_size}")
```

# Change labels position, background, font, and disable download button

Going back to the treemap example, it is possible to move the labels,
change the background, and also use any font that you like:

```{r treemap-style}
dout <- aggregate(cbind(count = rep(1, nrow(pokemon))) ~ type_1 + color_1, data = pokemon, FUN = length)
names(dout) <- c("type", "color", "count")

d3po(dout, width = 800, height = 600) %>%
  po_treemap(daes(size = count, group = type, color = color)) %>%
  po_labels(
    align = "center-middle", # default is "left-top"
    title = "Share of Pokemon by main type"
  ) %>%
  po_background("#ffcc00") %>%
  po_font("Comic Sans MS", 16, "uppercase") %>%
  po_download(FALSE) # default is TRUE
```
